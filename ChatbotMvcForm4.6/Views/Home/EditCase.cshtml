@model ChatbotMvcForm4._6.Models.Case
@{
    ViewBag.Title = "Chatbot Interaction";
}

<h2>Issue Description</h2>
@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "editForm" }))
{
    @Html.HiddenFor(m => m.ID)
    @Html.HiddenFor(m => m.RCAReport, new { id = "RCAReport" })
    @Html.HiddenFor(m => m.CaseNumber)
    @Html.HiddenFor(m => m.StatusIDFK)
    
    <!-- 添加必要的隐藏字段 -->
    @Html.HiddenFor(m => m.CreatedDate)
    @Html.HiddenFor(m => m.CreatedBy)
    @Html.HiddenFor(m => m.UpdatedDate)
    @Html.HiddenFor(m => m.UpdatedBy)
    @Html.HiddenFor(m => m.DepartmentIDFK)
    @Html.HiddenFor(m => m.CategoryIDFK)
    @Html.HiddenFor(m => m.AssignedToIDFK)
    @Html.HiddenFor(m => m.IsPrivate)
    @Html.HiddenFor(m => m.ResolutionDate)
    @Html.HiddenFor(m => m.Environment)
    @Html.HiddenFor(m => m.TaskID)
    @Html.HiddenFor(m => m.DefectPhaseID)
    @Html.HiddenFor(m => m.RCAID)
    @Html.HiddenFor(m => m.Subject)
    @Html.HiddenFor(m => m.Name)
    @Html.HiddenFor(m => m.AdditionInformation)
    
    <div>
        <label>PROJECT *</label>
        @Html.TextBoxFor(m => m.Project, new { @class = "form-control", required = "required" })
    </div>
    <div>
        <label>CATEGORY *</label>
        @Html.TextBoxFor(m => m.Category, new { @class = "form-control", required = "required" })
    </div>
    <div>
        <label>SEVERITY *</label>
        @Html.DropDownListFor(m => m.PriorityName, ViewBag.SeverityOptions as List<SelectListItem>, "-- Select Severity --", new { @class = "form-control", required = "required" })
        @Html.HiddenFor(m => m.Priority)
    </div>
    <div>
        <label>PRIORITY *</label>
        @Html.DropDownListFor(m => m.SeverityName, ViewBag.PriorityOptions as List<SelectListItem>, "-- Select Priority --", new { @class = "form-control", required = "required" })
        @Html.HiddenFor(m => m.PREFERENCE)
    </div>
    <div>
        <label>DEFECT PHASE *</label>
        @Html.TextBoxFor(m => m.DefectPhase, new { @class = "form-control", required = "required" })
    </div>
    <div>
        <label>TICKET OWNER *</label>
        @Html.TextBoxFor(m => m.TicketOwner, new { @class = "form-control", required = "required" })
    </div>
    <div>
        <label>EMAIL *</label>
        @Html.TextBoxFor(m => m.Email, new { @class = "form-control", required = "required" })
    </div>
    <div>
        <label>CONTACT NO</label>
        @Html.TextBoxFor(m => m.ContactNo, new { @class = "form-control" })
    </div>
    <div>
        <label>ASSIGNED TO</label>
        @Html.TextBoxFor(m => m.AssignedTo, new { @class = "form-control" })
    </div>
    <div>
        <label>SUMMARY *</label>
        @Html.TextBoxFor(m => m.Summary, new { @class = "form-control", required = "required" })
    </div>
    <div>
        <label>DESCRIPTION *</label>
        @Html.TextAreaFor(m => m.Description, new { @class = "form-control", required = "required", rows = 4 })
    </div>
    <div>
        <label>CHANGE STATUS TO *</label>
        @Html.DropDownList("ChangeStatusTo", new SelectList(new[]{"Open","Closed","In Progress"}), "Select Status", new { @class = "form-control" })
    </div>
    <div>
        <label>RCA</label>
        @Html.TextBoxFor(m => m.RCA, new { @class = "form-control", @readonly = "readonly" })
        <button type="button" id="viewRCAReportBtn" class="btn btn-success btn-sm" style="margin-top:5px;">View RCA Report</button>
    </div>
    <div>
        <label>LINK TICKETS</label>
        @Html.TextBoxFor(m => m.LinkedTickets, new { @class = "form-control" })
    </div>
    <div style="margin-top:20px">
        <button type="submit" class="btn btn-primary" id="btnSubmit">Save</button>
        <a href="@Url.Action("ViewCase", "Home", new { id = Model.ID })" class="btn btn-default">Cancel</a>
    </div>
}

<!-- Chatbot Window -->
<div id="chatbotWindow">
    <!-- Loader -->
    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <div class="loader-text">Processing your request...</div>
    </div>

    <div id="chatbotHeader">
        <h3>Chatbot Helper</h3>
        <button id="closeChatbot">✖</button>
    </div>

    <div id="chatbotTitle">Chatbot history</div>
    <div id="chatContainer">
        <div id="chatMessages">
            <div id="userMessages" class="messages-container"></div>
            <div id="assistantMessages" class="messages-container"></div>
        </div>
        <div id="messageControls">
            <button id="prevMessage">⬆</button>
            <button id="nextMessage">⬇</button>
        </div>
    </div>

    <div id="inputTitle">
        <span>Edit Details Below</span>
        <div class="section-controls">
            <button id="expandAllBtn">Expand All</button>
            <button id="collapseAllBtn">Collapse All</button>
        </div>
    </div>
    <div id="chatbot-input-area">
        <table id="formTable">
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Value</th>
                    <th>Manipulations</th>
                </tr>
            </thead>
            <tbody id="formContainer">
                <!-- Dynamic form content will be loaded here -->
            </tbody>
        </table>
    </div>
    <div id="chatbot-controls">
        <button id="sendBtn" class="btn-action">Send</button>
        <button id="confirmBtn" class="btn-action">Confirm</button>
    </div>
</div>

<style>
    /* Base styles */
    #chatbotWindow {
        display: none;
        position: fixed;
        width: 60%;
        height: 90%;
        background: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        z-index: 10;
        flex-direction: column;
        overflow: hidden;
    }

    /* Header */
    #chatbotHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f0f0f0;
        padding: 8px;
        cursor: move;
    }

    #closeChatbot {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
    }
        /* Loading animation styles */
    .loader-container {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin-bottom: 15px;
    }

    .loader-text {
        font-size: 18px;
        color: #333;
    }

    /* Chat section */
    #chatbotTitle {
        background: #f0f0f0;
        padding: 5px;
        font-weight: bold;
    }

    #chatContainer {
        height: 200px;
        border-bottom: 1px solid #ccc;
        overflow: hidden;
        position: relative;
    }

    #chatMessages {
        height: 190px;
        overflow-y: auto;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
    }

    .messages-container {
        padding: 5px;
    }

    .user-message, .ai-message {
        margin: 5px 0;
        padding: 5px;
        border-radius: 3px;
    }

    .user-message {
        background-color: #e6f0ff;
    }

    .ai-message {
        background-color: #e6ffe6;
    }

    #messageControls {
        position: absolute;
        right: 5px;
        top: 5px;
    }

        #messageControls button {
            margin: 0 2px;
            padding: 2px 5px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

    /* Form section */
    #inputTitle {
        background: #f0f0f0;
        padding: 5px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-controls button {
        margin-left: 5px;
        padding: 2px 5px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 12px;
    }

    #chatbot-input-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 5px;
    }

    #formTable {
        width: 100%;
        border-collapse: collapse;
    }

        #formTable thead {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
        }

    th, td {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
    }

    th {
        background: #f2f2f2;
    }
    /* Reduce first and third column */
    table th:first-child,
    table td:first-child {
        width: 35%;
    }

    table th:last-child,
    table td:last-child {
        width: 15%;
    }
    /* Increase width proportion of second column (Value) */
    table th:nth-child(2),
    table td:nth-child(2) {
        width: 50%; /* Increase to 65% or higher */
    }

    /* First column input style */
    table td:nth-child(1) input[type="text"] {
        width: 95%;
        box-sizing: border-box;
        padding: 3px;
    }

    /* Second column input style */
    table td:nth-child(2) input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        padding: 3px;
    }

    /* Controls */
    #chatbot-controls {
        padding: 8px;
        text-align: center;
        background: #f0f0f0;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 5px;
        cursor: pointer;
    }

    /* RCA Report Window Styles */
    .rca-report-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }
    
    .rca-report-window {
        position: fixed;
        top: 10%;
        left: 15%;
        width: 70%;
        height: 80%;
        background-color: #fff;
        z-index: 1001;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .rca-report-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f0f0f0;
        padding: 10px 15px;
        border-bottom: 1px solid #ccc;
    }
    
    .rca-report-title h3 {
        margin: 0;
    }
    
    .rca-report-title button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }
    
    .download-btn {
        background-color: #4CAF50 !important;
        color: white !important;
        padding: 5px 10px !important;
        border-radius: 3px !important;
        margin-right: 10px !important;
    }
    
    .rca-report-content {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        line-height: 1.5;
    }
    
    .rca-report-content h1 {
        font-size: 24px;
        margin-top: 0;
    }
    
    .rca-report-content h2 {
        font-size: 20px;
        margin-top: 20px;
    }
    
    .rca-report-content h3 {
        font-size: 18px;
    }
    
    .rca-report-content ul {
        margin: 5px 0;
        padding-left: 20px;
    }
    
    .rca-report-content li {
        margin-bottom: 5px;
    }

    /* Utility */
    .hidden {
        display: none;
    }

    .section-header {
        background: #f5f5f5;
        cursor: pointer;
    }

    .visibility-toggle {
        margin-left: 5px;
        cursor: pointer;
    }

    /* AI推荐窗口样式 */
    .recommendation-window {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }
    
    .recommendation-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f0f0f0;
        border-bottom: 1px solid #ccc;
    }
    
    .recommendation-title h3 {
        margin: 0;
    }
    
    .recommendation-title button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }
    
    .recommendation-content {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
    }
    
    .recommendation-content .section {
        margin-bottom: 20px;
    }
    
    .recommendation-content h4 {
        margin-top: 0;
        color: #333;
    }
    
    .recommendation-content ul {
        list-style-type: none;
        padding-left: 0;
    }
    
    .recommendation-content li {
        margin-bottom: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .recommendation-content li strong {
        display: block;
        margin-bottom: 5px;
        color: #007bff;
    }
    
    .recommendation-content li p {
        margin: 0;
        color: #666;
    }
</style>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        // 下拉框事件处理
        $(document).ready(function() {
            // Severity下拉框变化事件
            $("#PriorityName").change(function() {
                var selectedText = $(this).find("option:selected").text();
                var selectedValue = $(this).val();
                
                if (selectedValue) {
                    $("#Priority").val(selectedValue);
                }
            });
            
            // Priority下拉框变化事件
            $("#SeverityName").change(function() {
                var selectedText = $(this).find("option:selected").text();
                var selectedValue = $(this).val();
                
                if (selectedValue) {
                    $("#PREFERENCE").val(selectedValue);
                }
            });
        });
        
        let isChatbotFinished = false;
        
        $(document).ready(function() {
            let isFinal = false;
            let issueDesc = "";
            let formData = {};
            let sectionStates = {};

            // 初始时禁用View Report按钮，但保持可见
            $("#viewReportBtn").prop("disabled", true);

            // 添加View Report按钮的点击事件
            $("#viewReportBtn").click(function() {
                // 获取保存的RCA报告数据
                let reportData = $("body").data("rcaReportData");
                if (reportData) {
                    showRCAReport(reportData);
                } else {
                    alert("No RCA report data available. Please submit the form first.");
                }
            });

            // 自适应设置窗口位置
            function positionChatbotWindow() {
                let windowHeight = $(window).height();
                let windowWidth = $(window).width();
                let chatbotHeight = $("#chatbotWindow").outerHeight();
                let chatbotWidth = $("#chatbotWindow").outerWidth();
                
                // 计算适当的top值，确保窗口在视图中有一定偏移
                let topPosition = Math.max(windowHeight * 0.15, 50);
                
                // 确保在较小屏幕上窗口不会超出底部
                if (topPosition + chatbotHeight > windowHeight) {
                    topPosition = Math.max(10, windowHeight * 0.05);
                }
                
                // 计算左侧位置使窗口水平居中
                let leftPosition = (windowWidth - chatbotWidth) / 2;
                if (leftPosition < 0) leftPosition = 0;
                
                // 设置窗口位置 - 不使用transform以避免与draggable冲突
                $("#chatbotWindow").css({
                    "position": "fixed",
                    "top": topPosition + "px",
                    "left": leftPosition + "px"
                });
            }
            
            // 初始定位
            $("#chatbotWindow").css("display", "flex").hide(); // 先使窗口可测量但不可见
            setTimeout(function() {
                positionChatbotWindow();
            }, 0);
            
            // 窗口大小改变时重新定位
            $(window).resize(function() {
                if ($("#chatbotWindow").is(":visible")) {
                    positionChatbotWindow();
                }
            });
            
            // Make chatbot window draggable - 调整draggable设置
            $("#chatbotWindow").draggable({
                handle: "#chatbotHeader",
                containment: "window", // 改为window而不是document
                cursor: "move",
                start: function (event, ui) {
                    // 保存初始位置
                    $(this).data('startPos', $(this).position());
                },
                stop: function (event, ui) {
                    // 防止位置异常
                    if (ui.position.left < 0 || ui.position.top < 0) {
                        $(this).css($(this).data('startPos'));
                    }
                }
            });

            // Submit button
            $("#submitBtn").click(function(e) {
                e.preventDefault();
                issueDesc = $("#issueDesc").val();
                if (issueDesc.trim() === "") {
                    alert("Please enter an issue description.");
                    return;
                }
                $("#chatbotWindow").css("display", "flex").show();

                $(this).prop("disabled", true);

                $("#loader").css("display", "flex").show();

                // Initialize formData
                formData = {
                    category: "",
                    task: "",
                    summary: "",
                    description: "",
                    root_causes: [],
                    conclusion: "",
                    impact_analysis: { 
                        affected_module: "", 
                        severity: "Severity 1", 
                        priority: "Medium", 
                        defect_phase: "Unknown",
                        dynamic_fields: [] 
                    },
                    resolution: { fix_applied: "", dynamic_fields: [] },
                    preventive_measures: { general_measure: "", dynamic_fields: [] },
                    supplementary_info: { dynamic_fields: [] },
                    additional_questions: { dynamic_fields: [] }
                };

                // Initialize section states
                sectionStates = {
                    category: { expanded: true, visible: true },
                    task: { expanded: true, visible: true },
                    summary: { expanded: true, visible: true },
                    description: { expanded: true, visible: true },
                    root_causes: { expanded: true, visible: true },
                    conclusion: { expanded: true, visible: true },
                    impact_analysis: { expanded: true, visible: true },
                    resolution: { expanded: true, visible: true },
                    preventive_measures: { expanded: true, visible: true },
                    supplementary_info: { expanded: true, visible: true },
                    additional_questions: { expanded: true, visible: true }
                };

                loadForm();
                sendMessage(isFinal);
            });

            // Send button
            $("#sendBtn").click(function() {
                sendMessage(isFinal);
            });

            // Confirm button
            $("#confirmBtn").click(function() {
                // 更新formData以确保使用最新的表单数据
                updateFormDataFromUI();
                
                // 获取当前的conclusion值
                let conclusion = formData.conclusion || "";
                
                // 更新formData，设置description为conclusion
                formData.description = conclusion;
                
                // 更新文本区域展示
                $("#issueDesc").val(conclusion);

                // 显示加载动画
                $("#loader").css("display", "flex").show();

                $.ajax({
                    url: '@Url.Action("ChatbotOptimize", "Home")',
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({ formData: formData, isFinal: true }),
                    success: function (response) {
                        // 隐藏加载动画
                        $("#loader").hide();

                        if (response.status === "success") {
                            if (response.rca_report) {
                                $("#RCAReport").val(response.rca_report);
                                // 隐藏聊天窗口
                                $("#chatbotWindow").hide();
                                $("#chatMessages").html("");
                                
                                // 创建一个容器来保存报告数据
                                $("body").data("rcaReportData", response.rca_report);
                                
                                // 显示提示
                                alert("Form submitted successfully! You can now view the RCA report.");
                                
                                // 启用提交按钮和View Report按钮
                                $("#btnSubmit").prop("disabled", false);
                                $("#viewReportBtn").prop("disabled", false);
                            } else {
                                // 如果没有RCA报告，显示常规成功消息
                                $("#chatbotWindow").hide();
                                $("#chatMessages").html("");
                                alert("Form submitted successfully!");
                                $("#btnSubmit").prop("disabled", false);
                            }
                        } else if (response.error) {
                            // 处理错误响应
                            console.error("Error from API:", response.error);
                            alert("Error: " + response.error);

                            // 如果有响应字符串，可以显示或处理
                            if (response.response) {
                                console.log("Response data:", response.response);
                                appendMessage("System", "Error occurred but received response: " + response.response, "ai-message");
                            }
                        } else {
                            // 处理其他响应
                            alert("Operation completed with unknown status");
                        }
                    },
                    error: function(xhr, status, error) {
                        // 隐藏加载动画
                        $("#loader").hide();
                        
                        console.error("Error:", error);
                        alert("Chatbot service failed. Status: " + xhr.status);
                    }
                });
            });

            // Close button
            $("#closeChatbot").click(function() {
                $("#chatbotWindow").hide();
                $("#chatMessages").html("");
            });

            // Expand/Collapse All buttons
            $("#expandAllBtn").click(function() {
                Object.keys(sectionStates).forEach(key => {
                    sectionStates[key].expanded = true;
                });
                loadForm();
            });

            $("#collapseAllBtn").click(function() {
                Object.keys(sectionStates).forEach(key => {
                    sectionStates[key].expanded = false;
                });
                loadForm();
            });

            // Message navigation
            let currentMessageIndex = 0;

            $("#prevMessage").click(function() {
                if (currentMessageIndex > 0) {
                    currentMessageIndex--;
                    scrollToMessage(currentMessageIndex);
                }
            });

            $("#nextMessage").click(function() {
                let totalMessages = $("#chatMessages .chat-message").length;
                if (currentMessageIndex < totalMessages - 1) {
                    currentMessageIndex++;
                    scrollToMessage(currentMessageIndex);
                }
            });

            function scrollToMessage(index) {
                let targetMessage = $("#message-" + index);
                if (targetMessage.length) {
                    $("#chatMessages").animate({
                        scrollTop: targetMessage.offset().top - $("#chatMessages").offset().top + $("#chatMessages").scrollTop()
                    }, 300);
                }
            }

            function assignMessageIds() {
                $("#chatMessages .chat-message").each(function(index) {
                    $(this).attr("id", "message-" + index);
                });
            }

            // Send message to server
            function sendMessage(finalStatus) {
                // 显示加载动画
                $("#loader").css("display", "flex").show();

                // 先更新formData以确保使用最新的表单数据
                updateFormDataFromUI();

                let payload;

                if (finalStatus) {
                    // 使用当前的formData而不是空对象
                    payload = JSON.stringify({ formData: formData, isFinal: true });
                } else {
                    let requestData = { formData: {}, isFinal: false };

                    if ($("#submitBtn").is(":disabled")) {
                        // 首次发送，使用初始化的数据加上用户输入
                        requestData.formData = {
                            category: "",
                            task: "",
                            summary: "",
                            description: issueDesc,
                            root_causes: [],
                            conclusion: "",
                            impact_analysis: {
                                affected_module: "",
                                severity: "Severity 1",
                                priority: "Medium",
                                defect_phase: "Unknown",
                                dynamic_fields: []
                            },
                            resolution: {
                                fix_applied: "",
                                dynamic_fields: []
                            },
                            preventive_measures: {
                                general_measure: "",
                                dynamic_fields: []
                            },
                            supplementary_info: {
                                dynamic_fields: []
                            },
                            additional_questions: {
                                dynamic_fields: []
                            }
                        };
                    } else {
                        // 后续发送，使用更新后的formData
                        requestData.formData = formData;
                    }

                    payload = JSON.stringify(requestData);
                }

                appendMessage("User", payload, "user-message");

                $.ajax({
                    url: '@Url.Action("ChatbotOptimize", "Home")',
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    data: payload,
                    success: function (response) {
                        

                        Object.keys(formData).forEach(key => {
                            if (typeof formData[key] === "object" && formData[key] !== null) {
                                Object.assign(formData[key], mapResponseToFormData(response)[key]);
                            } else {
                                formData[key] = mapResponseToFormData(response)[key];
                            }
                        });

                        loadForm();

                        let formattedJson = JSON.stringify(response, null, 2);
                        appendMessage("Assistant", formattedJson, "ai-message");
                    },
                    error: function (xhr, status, error) {
                        $("#loader").hide();

                        console.error("Error:", error);
                        alert("Chatbot service failed. Status: " + xhr.status);
                    }
                });
            }

            // 从UI表单中获取最新数据更新formData
            function updateFormDataFromUI() {
                // 表单元素已经通过onChange事件直接更新了formData对象
                // 由于有可能存在需要即时计算但尚未触发onChange的输入框，
                // 我们可以查找并手动触发这些输入框的更新

                // 确保基本字段（非嵌套）的值已更新
                $("#formContainer input").each(function() {
                    // 获取当前输入框的值
                    const value = $(this).val();
                    
                    // 获取所在行的字段名称（通常在第一个td中）
                    const row = $(this).closest("tr");
                    const labelCell = row.find("td:first");
                    
                    // 找到这个输入框对应的字段路径
                    // 这种方法可能不够精确，但是可以作为后备方案
                    if (labelCell.length > 0) {
                        const label = labelCell.text().trim();
                        
                        // 尝试匹配简单字段
                        for (const key of ["category", "task", "summary", "description", "conclusion"]) {
                            if (label.toLowerCase() === key.toLowerCase()) {
                                formData[key] = value;
                                break;
                            }
                        }
                        
                        // 处理根因列表
                        if (label.startsWith("Root Cause")) {
                            const index = parseInt(label.replace("Root Cause ", "")) - 1;
                            if (!isNaN(index) && index >= 0 && index < formData.root_causes.length) {
                                formData.root_causes[index] = value;
                            }
                        }
                    }
                });
                
                // 注意：动态字段和复杂结构通常已经通过各自的onChange回调更新了formData
                // 因此不需要额外处理
                
                // 打印用于调试
                console.log("Updated formData:", JSON.stringify(formData));
            }

            // 将服务器响应映射到表单数据格式
            function mapResponseToFormData(response) {
                return {
                    category: response.Category || "",
                    task: response.Task || "",
                    summary: response.Summary || "",
                    description: response.Description || "",
                    root_causes: response.RootCauses || [],
                    conclusion: response.Conclusion || "",
                    impact_analysis: {
                        affected_module: response.ImpactAnalysis?.AffectedModule || "",
                        severity: response.ImpactAnalysis?.Severity || "",
                        priority: response.ImpactAnalysis?.Priority || "",
                        defect_phase: response.ImpactAnalysis?.DefectPhase || "",
                        dynamic_fields: response.ImpactAnalysis?.DynamicFields?.map(mapDynamicField) || []
                    },
                    resolution: {
                        fix_applied: response.Resolution?.FixApplied || "",
                        dynamic_fields: response.Resolution?.DynamicFields?.map(mapDynamicField) || []
                    },
                    preventive_measures: {
                        general_measure: response.PreventiveMeasures?.GeneralMeasure || "",
                        dynamic_fields: response.PreventiveMeasures?.DynamicFields?.map(mapDynamicField) || []
                    },
                    supplementary_info: {
                        dynamic_fields: response.SupplementaryInfo?.DynamicFields?.map(mapDynamicField) || []
                    },
                    additional_questions: {
                        dynamic_fields: response.AdditionalQuestions?.DynamicFields?.map(mapDynamicField) || []
                    }
                };
            }

            function mapDynamicField(field) {
                return {
                    key: field.Key || "",
                    value: field.Value || "",
                    type: field.Type || "string",
                    is_confirmed: field.IsConfirmed || false
                };
            }

            // Append message to chat
            function appendMessage(sender, message, messageType) {
                let chatContainer = sender === "User" ? $("#assistantMessages") : $("#userMessages");

                let messageElement = $("<div>").addClass("chat-message").addClass(messageType);
                let senderLabel = $("<strong>").text(sender + ":");
                messageElement.append(senderLabel);

                let formattedMessage;
                try {
                    let jsonObject = typeof message === "string" ? JSON.parse(message) : message;
                    formattedMessage = $("<pre>").text(JSON.stringify(jsonObject, null, 2));
                } catch (e) {
                    formattedMessage = $("<pre>").text(message);
                }

                messageElement.append(formattedMessage);
                chatContainer.append(messageElement);

                assignMessageIds();

                if (chatContainer.length) {
                    setTimeout(() => {
                        chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
                    }, 50);
                }
            }

            // Form utilities
            function createInputField(value, onChange, disabled = false) {
                let input = document.createElement("input");
                input.type = "text";
                input.value = value;
                input.disabled = disabled;
                input.oninput = (e) => onChange(e.target.value);
                return input;
            }

            function createButton(text, className, onClick) {
                let button = document.createElement("button");
                button.textContent = text;
                button.className = className + " btn-action";
                button.onclick = onClick;
                return button;
            }

            function toggleSectionVisibility(sectionKey) {
                sectionStates[sectionKey].visible = !sectionStates[sectionKey].visible;
                loadForm();
            }

            function toggleSectionExpansion(sectionKey) {
                sectionStates[sectionKey].expanded = !sectionStates[sectionKey].expanded;
                loadForm();
            }

            function createSectionHeaderRow(title, sectionKey) {
                let row = document.createElement("tr");
                row.className = "section-header";

                let titleCell = document.createElement("td");
                titleCell.colSpan = 2;

                let expandIcon = document.createElement("span");
                expandIcon.textContent = sectionStates[sectionKey].expanded ? "▼ " : "► ";
                expandIcon.style.cursor = "pointer";
                expandIcon.onclick = () => toggleSectionExpansion(sectionKey);

                let titleText = document.createTextNode(title);

                titleCell.appendChild(expandIcon);
                titleCell.appendChild(titleText);

                let actionCell = document.createElement("td");

                // Add button for specific sections
                if (sectionKey === "root_causes") {
                    let addButton = createButton("Add", "btn-new", () => {
                        formData.root_causes.push("");
                        loadForm();
                    });
                    actionCell.appendChild(addButton);
                } else if (["impact_analysis", "resolution", "preventive_measures", "supplementary_info", "additional_questions"].includes(sectionKey)) {
                    let addButton = createButton("New", "btn-new", () => {
                        if (!formData[sectionKey].dynamic_fields) {
                            formData[sectionKey].dynamic_fields = [];
                        }
                        formData[sectionKey].dynamic_fields.push({ key: "New Field", value: "", type: "string", is_confirmed: true });
                        loadForm();
                    });
                    actionCell.appendChild(addButton);
                }

                row.appendChild(titleCell);
                row.appendChild(actionCell);

                row.onclick = (e) => {
                    if (e.target !== expandIcon && e.target.tagName !== 'BUTTON') {
                        toggleSectionExpansion(sectionKey);
                    }
                };

                return row;
            }

            function createFieldRow(label, value, onChange) {
                let row = document.createElement("tr");

                let labelCell = document.createElement("td");
                labelCell.textContent = label;

                let valueCell = document.createElement("td");
                let input = createInputField(value, onChange);
                valueCell.appendChild(input);

                let actionCell = document.createElement("td");

                row.appendChild(labelCell);
                row.appendChild(valueCell);
                row.appendChild(actionCell);

                return row;
            }

            function createDynamicFieldRow(field, index, groupKey) {
                let row = document.createElement("tr");

                let keyCell = document.createElement("td");
                
                // 创建包含复选框和输入框的容器
                let inputContainer = document.createElement("div");
                inputContainer.style.display = "flex";
                inputContainer.style.alignItems = "center";
                inputContainer.style.width = "100%";

                // Add visibility toggle (confirm/unconfirm) checkbox
                let visibilityToggle = document.createElement("input");
                visibilityToggle.type = "checkbox";
                visibilityToggle.checked = field.is_confirmed;
                visibilityToggle.style.marginRight = "5px";
                visibilityToggle.style.flexShrink = "0"; // 不允许复选框缩小
                visibilityToggle.style.width = "15px"; // 固定宽度
                visibilityToggle.onchange = () => {
                    formData[groupKey].dynamic_fields[index].is_confirmed = visibilityToggle.checked;
                    loadForm();
                };

                let keyInput = createInputField(field.key, (newKey) => {
                    formData[groupKey].dynamic_fields[index].key = newKey;
                }, !field.is_confirmed);
                keyInput.style.flexGrow = "1"; // 允许输入框占用剩余空间

                // 将两个元素添加到容器中，而不是直接添加到cell
                inputContainer.appendChild(visibilityToggle);
                inputContainer.appendChild(keyInput);
                
                // 将容器添加到cell
                keyCell.appendChild(inputContainer);

                let valueCell = document.createElement("td");
                let valueInput = createInputField(field.value, (newValue) => {
                    formData[groupKey].dynamic_fields[index].value = newValue;
                }, !field.is_confirmed);
                valueCell.appendChild(valueInput);

                let actionCell = document.createElement("td");
                let deleteButton = createButton("Delete", "btn-delete", () => {
                    formData[groupKey].dynamic_fields.splice(index, 1);
                    loadForm();
                });
                actionCell.appendChild(deleteButton);

                row.appendChild(keyCell);
                row.appendChild(valueCell);
                row.appendChild(actionCell);

                return row;
            }

            function createDynamicSection(groupKey, title) {
                if (!sectionStates[groupKey].visible) {
                    return [createSectionHeaderRow(title, groupKey)];
                }

                let rows = [createSectionHeaderRow(title, groupKey)];

                if (!sectionStates[groupKey].expanded) {
                    return rows;
                }

                let groupData = formData[groupKey];
                if (!groupData) return rows;

                // Basic fields
                Object.keys(groupData).forEach(key => {
                    if (key !== "dynamic_fields") {
                        rows.push(createFieldRow(
                            key.replace(/_/g, " "),
                            groupData[key],
                            (newValue) => { formData[groupKey][key] = newValue; }
                        ));
                    }
                });

                // Dynamic fields
                if (groupData.dynamic_fields) {
                    rows.push(...groupData.dynamic_fields.map((field, index) =>
                        createDynamicFieldRow(field, index, groupKey)
                    ));
                }

                return rows;
            }

            function createSimpleSection(key, title) {
                if (!sectionStates[key].visible) {
                    return [createSectionHeaderRow(title, key)];
                }

                let rows = [createSectionHeaderRow(title, key)];

                if (!sectionStates[key].expanded) {
                    return rows;
                }

                rows.push(createFieldRow(title, formData[key], (value) => {
                    formData[key] = value;
                }));

                return rows;
            }

            function createRootCausesSection() {
                if (!sectionStates.root_causes.visible) {
                    return [createSectionHeaderRow("Root Causes", "root_causes")];
                }

                let rows = [createSectionHeaderRow("Root Causes", "root_causes")];

                if (!sectionStates.root_causes.expanded) {
                    return rows;
                }

                if (!Array.isArray(formData.root_causes)) {
                    formData.root_causes = [];
                }
                if (formData.root_causes.length === 0) {
                    formData.root_causes.push("");
                }

                // Root causes items
                formData.root_causes.forEach((cause, index) => {
                    let row = document.createElement("tr");

                    let labelCell = document.createElement("td");
                    labelCell.textContent = `Root Cause ${index + 1}`;

                    let valueCell = document.createElement("td");
                    let input = createInputField(cause, (newValue) => {
                        formData.root_causes[index] = newValue;
                    });
                    valueCell.appendChild(input);

                    let actionCell = document.createElement("td");
                    if (index > 0) {
                        let deleteButton = createButton("Delete", "btn-delete", () => {
                            formData.root_causes.splice(index, 1);
                            loadForm();
                        });
                        actionCell.appendChild(deleteButton);
                    }

                    row.appendChild(labelCell);
                    row.appendChild(valueCell);
                    row.appendChild(actionCell);

                    rows.push(row);
                });

                return rows;
            }

            function loadForm() {
                // 隐藏加载动画
                $("#loader").hide();

                let formContainer = document.getElementById("formContainer");
                formContainer.innerHTML = "";

                // Append sections in order
                formContainer.append(...createSimpleSection("category", "Category"));
                formContainer.append(...createSimpleSection("task", "Task"));
                formContainer.append(...createSimpleSection("summary", "Summary"));
                formContainer.append(...createSimpleSection("description", "Description"));
                formContainer.append(...createRootCausesSection());
                formContainer.append(...createSimpleSection("conclusion", "Conclusion"));
                formContainer.append(...createDynamicSection("impact_analysis", "Impact Analysis"));
                formContainer.append(...createDynamicSection("resolution", "Resolution"));
                formContainer.append(...createDynamicSection("preventive_measures", "Preventive Measures"));
                formContainer.append(...createDynamicSection("supplementary_info", "Supplementary Info"));
                formContainer.append(...createDynamicSection("additional_questions", "Additional Questions"));
            }

            // 添加showRCAReport函数用于显示RCA报告
            function showRCAReport(reportContent) {
                // 创建RCA报告窗口
                let rcaReportWindow = $("<div>").attr("id", "rcaReportWindow").addClass("rca-report-window");
                
                // 添加标题栏
                let titleBar = $("<div>").addClass("rca-report-title");
                titleBar.append($("<h3>").text("RCA"));
                
                // 添加关闭按钮
                let closeBtn = $("<button>").html("&times;").click(function () {
                    $("#rcaReportWindow").remove();
                    $("#rcaReportOverlay").remove();
                });
                titleBar.append(closeBtn);
                
                // 添加下载按钮
                let downloadBtn = $("<button>").text("Download report").addClass("download-btn").click(function () {
                    let blob = new Blob([reportContent], { type: "text/plain;charset=utf-8" });
                    let link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "RCA_Report_" + new Date().toISOString().slice(0, 10) + ".txt";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                titleBar.append(downloadBtn);
                
                // 添加报告内容
                let reportContentDiv = $("<div>").addClass("rca-report-content");
                
                // 格式化报告内容
                let formattedReport = reportContent.replace(/\n/g, "<br>");
                formattedReport = formattedReport.replace(/# (.*?)<br>/g, "<h1>$1</h1>");
                formattedReport = formattedReport.replace(/## (.*?)<br>/g, "<h2>$1</h2>");
                formattedReport = formattedReport.replace(/### (.*?)<br>/g, "<h3>$1</h3>");
                formattedReport = formattedReport.replace(/- (.*?)<br>/g, "<ul><li>$1</li></ul>");
                formattedReport = formattedReport.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                
                reportContentDiv.html(formattedReport);
                
                rcaReportWindow.append(titleBar);
                rcaReportWindow.append(reportContentDiv);
                
                // 添加覆盖层，点击时关闭报告窗口
                let overlay = $("<div>").attr("id", "rcaReportOverlay").addClass("rca-report-overlay");
                overlay.click(function (e) {
                    if (e.target === this) {
                        $("#rcaReportWindow").remove();
                        $("#rcaReportOverlay").remove();
                    }
                });
                
                $("body").append(overlay);
                $("body").append(rcaReportWindow);
            }
            
            // 为View RCA Report按钮添加点击事件
            $("#viewRCAReportBtn").on("click", function(e) {
                e.preventDefault();
                console.log("View RCA Report按钮被点击");
                
                // 获取RCA报告数据
                let reportData = $("#RCAReport").val();
                
                console.log("RCA Report Data:", reportData ? "Found (length: " + reportData.length + ")" : "Not found");
                
                if (reportData && reportData.trim() !== "") {
                    // 显示RCA报告窗口
                    showRCAReport(reportData);
                } else {
                    // 提示用户没有报告
                    alert("此工单暂无RCA报告。请先提交状态为'Closed'的表单。");
                }
            });
            
            // 恢复表单提交拦截处理
            $("#editForm").off("submit").on("submit", function(e) {
                console.log("表单提交，状态检查: ChangeStatusTo=", $("#ChangeStatusTo").val(), 
                           "isChatbotFinished=", isChatbotFinished);
                
                // 只有状态为Closed且未执行过Chatbot时拦截
                if ($("#ChangeStatusTo").val() === "Closed" && !isChatbotFinished) {
                    console.log("拦截表单提交，启动Chatbot");
                    e.preventDefault(); // 阻止表单提交
                    
                    // 调用Chatbot触发函数
                    triggerChatbotWindow();
                    return false;
                }
                
                console.log("允许表单正常提交：状态不是Closed或已执行过Chatbot");
                return true; // 允许表单正常提交
            });
            
            // 恢复确认按钮处理，确保正确保存RCA报告
            $("#confirmBtn").off("click").on("click", function() {
                isChatbotFinished = true;
                
                // 显示加载动画
                $("#loader").css("display", "flex").show();
                
                // 发送最终请求
                $.ajax({
                    url: '@Url.Action("ChatbotOptimize", "Home")',
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({ formData: formData, isFinal: true }),
                    success: function(response) {
                        $("#loader").hide();
                        
                        if (response.status === "success") {
                            // 如果有RCA报告，保存起来
                            if (response.rca_report) {
                                // 存储到隐藏字段
                                $("#RCAReport").val(response.rca_report);
                                
                                // 同时存储到内存中，方便快速访问
                                $("body").data("rcaReportData", response.rca_report);
                                
                                console.log("成功接收RCA报告，长度:", response.rca_report.length);
                                console.log("报告前50个字符:", response.rca_report.substring(0, 50));
                                
                                // 启用View RCA Report按钮
                                $("#viewRCAReportBtn").prop("disabled", false);
                                
                                // 弹窗提示
                                alert("RCA报告已生成，您可以点击'View RCA Report'按钮查看。");
                            }
                            
                            // 隐藏Chatbot窗口
                            $("#chatbotWindow").hide();
                            $("#chatMessages").html("");
                            
                            // 启用提交按钮
                            $("#btnSubmit").prop("disabled", false);
                        } else if (response.error) {
                            console.error("API错误:", response.error);
                            alert("错误: " + response.error);
                        } else {
                            alert("操作完成，但状态未知");
                        }
                    },
                    error: function(xhr, status, error) {
                        $("#loader").hide();
                        console.error("错误:", error);
                        alert("Chatbot服务调用失败，请重试。");
                    }
                });
            });
            
            function triggerChatbotWindow() {
                // 获取表单字段值
                var category = $("#Category").val() || "";
                var severity = $("#Priority").val() || "";
                var task = $("#Task").val() || "";
                var priority = $("#PREFERENCE").val() || "";
                var defectPhase = $("#DefectPhase").val() || "";
                var summary = $("#Summary").val() || "";
                var description = $("#Description").val() || "";
                
                if (description.trim() === "") {
                    alert("请输入问题描述");
                    return;
                }
                
                // 显示Chatbot窗口
                $("#chatbotWindow").css("display", "flex").show();
                $("#btnSubmit").prop("disabled", true);
                $("#loader").css("display", "flex").show();
                
                // 初始化formData
                formData = {
                    category: category,
                    task: task,
                    summary: summary,
                    description: description,
                    root_causes: [""],
                    conclusion: "",
                    impact_analysis: {
                        affected_module: "",
                        severity: severity,
                        priority: priority,
                        defect_phase: defectPhase,
                        dynamic_fields: []
                    },
                    resolution: { fix_applied: "", dynamic_fields: [] },
                    preventive_measures: { general_measure: "", dynamic_fields: [] },
                    supplementary_info: { dynamic_fields: [] },
                    additional_questions: { dynamic_fields: [] }
                };
                
                // 初始化section状态
                sectionStates = {
                    category: { expanded: true, visible: false },
                    task: { expanded: true, visible: false },
                    summary: { expanded: true, visible: false },
                    description: { expanded: true, visible: false },
                    root_causes: { expanded: true, visible: true },
                    conclusion: { expanded: true, visible: true },
                    impact_analysis: { expanded: true, visible: true },
                    resolution: { expanded: true, visible: true },
                    preventive_measures: { expanded: true, visible: true },
                    supplementary_info: { expanded: true, visible: true },
                    additional_questions: { expanded: true, visible: true }
                };
                
                // 加载表单并发送请求
                loadForm();
                
                // 直接发送API请求
                $.ajax({
                    url: '@Url.Action("ChatbotOptimize", "Home")',
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({ formData: formData, isFinal: false }),
                    success: function(response) {
                        $("#loader").hide();
                        
                        // 更新formData
                        Object.keys(formData).forEach(key => {
                            if (typeof formData[key] === "object" && formData[key] !== null) {
                                Object.assign(formData[key], mapResponseToFormData(response)[key]);
                            } else {
                                formData[key] = mapResponseToFormData(response)[key];
                            }
                        });
                        
                        // 重新加载表单
                        loadForm();
                        
                        // 显示消息
                        let formattedJson = JSON.stringify(response, null, 2);
                        appendMessage("Assistant", formattedJson, "ai-message");
                    },
                    error: function(xhr, status, error) {
                        $("#loader").hide();
                        console.error("Error:", error);
                        alert("Chatbot服务调用失败，请重试。");
                    }
                });
            }
        });
    </script>
}